# Авторизация внешних служб в надстройке Office

С помощью популярных веб-служб, в том числе Office 365, Google, Facebook, LinkedIn, SalesForce и GitHub, разработчики могут предоставлять пользователям доступ к их учетным записям в других приложениях. Благодаря этому вы можете включать эти службы в свои надстройки Office. 

Стандартная платформа, позволяющая обеспечить доступ веб-приложения к веб-службе, — OAuth 2.0. В большинстве ситуаций не обязательно знать абсолютно все о работе платформы, чтобы использовать ее в своей надстройке. Доступно множество библиотек, где эти сведения изложены в краткой форме.

Основной принцип работы OAuth заключается в том, что приложение может быть субъектом безопасности для самого себя (как пользователь или группа) и использовать собственное удостоверение и набор разрешений. В большинстве типичных сценариев, когда пользователь выполняет действие в надстройке Office, требующее вовлечения веб-службы, надстройка отправляет службе запрос на получение определенного набора разрешений для учетной записи пользователя. Затем служба предлагает пользователю предоставить надстройке эти разрешения. После предоставления разрешений служба отправляет надстройке небольшой зашифрованный *маркер доступа*. Надстройка может использовать службу, включая этот маркер во все свои запросы к API-интерфейсам службы. Но надстройка может действовать только в рамках разрешений, предоставленных ей пользователем. Кроме того, срок действия маркера ограничен указанным периодом времени.

Для разных сценариев разработано несколько шаблонов OAuth, называемых *потоками* или *типами предоставления*. Ниже представлены два самых важных из них.

- **Неявный поток**. Обмен данными между надстройкой и веб-службой реализуется с помощью JavaScript на стороне клиента.
- **Поток кода авторизации**. Используется подключение типа *сервер-сервер* между веб-приложением надстройки и веб-службой. Следовательно, она реализуется с помощью серверного кода.

Потоки предназначены для защиты удостоверения и авторизации приложения. В потоке кода авторизации вам предоставляется *секрет клиента*, который необходимо держать в тайне. Одностраничное приложение (SPA) не может защитить секрет, поэтому рекомендуем использовать в таких приложениях неявный поток. 

Следует изучить также все остальные плюсы и минусы обоих потоков. Рекомендуем начать с официальных определений, представленных в разделах [Код авторизации](https://tools.ietf.org/html/rfc6749#section-1.3.1) и [Неявный поток](https://tools.ietf.org/html/rfc6749#section-1.3.2). 

>**Примечание.** Вы также можете полностью поручить службе-посреднику авторизацию и передачу маркера доступа надстройке. Дополнительные сведения см. в разделе *Службы-посредники* далее в этой статье.

## Использование неявного потока в надстройках Office
Лучший способ узнать, поддерживает ли веб-служба неявный поток, — обратиться к документации.

Для служб, поддерживающих неявный поток, мы предоставляем библиотеку JavaScript, которая выполняет всю тонкую работу автоматически:

[Office-js-helpers](https://github.com/OfficeDev/office-js-helpers)

Папка \demo этого репозитория содержит пример надстройки, использующий библиотеку для доступа к некоторым популярным службам, в том числе Google, Facebook и Office 365.

См. также раздел **Библиотеки** далее в этой статье.

## Использование потока кода авторизации в надстройках Office

Доступно несколько примеров надстроек, использующих поток кода авторизации:

- [Office-Add-in-Nodejs-ServerAuth](https://github.com/OfficeDev/Office-Add-in-Nodejs-ServerAuth) (NodeJS).
- [PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart](https://github.com/OfficeDev/PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart) (ASP.NET MVC).

Доступно множество библиотек, позволяющих реализовать поток кода авторизации на различных языках и платформах. Дополнительные сведения см. в разделе **Библиотеки** далее в этой статье.

### Функции ретрансляторов и прокси-серверов

Вы можете использовать поток кода авторизации даже с веб-приложением без сервера. Для этого необходимо сохранить *идентификатор клиента* и *секрет клиента* в простой функции, размещенной в такой службе, как [Функции Azure](https://azure.microsoft.com/en-us/services/functions) или [Amazon Lambda](https://aws.amazon.com/lambda).
Функция обменивает тот или иной код на соответствующий *маркер доступа* и ретранслирует его обратно клиенту. Безопасность этого подхода зависит от того, как защищен доступ к функции.

Для использования такого подхода надстройка выводит пользовательский интерфейс или всплывающее окно с экраном входа в веб-службу (например, Google или Facebook). Когда пользователь выполнит вход и предоставит надстройке разрешение на доступ к своим ресурсам в веб-службе, разработчик получит код, который затем можно отправить веб-функции. Службы, описанные в разделе **Службы-посредники** этой статьи, используют поток, подобный этому. 

## Библиотеки

Библиотеки доступны для многих языков и платформ, а также для обоих потоков. Некоторые из них предназначены для общего применения, а другие — для определенных веб-служб. 

Библиотеки для **Office 365 и других служб, использующих Azure Active Directory в качестве поставщика авторизации,** указаны в статье [Библиотеки проверки подлинности Azure Active Directory](https://azure.microsoft.com/en-us/documentation/articles/active-directory-authentication-libraries/). Кроме того, доступна предварительная версия [библиотеки проверки подлинности (Майкрософт)](https://www.nuget.org/packages/Microsoft.Identity.Client).

Если вы используете **Google**, выполните на странице [GitHub.com/Google](https://github.com/google) поиск по запросу "auth" или названию языка. Имена почти всех соответствующих репозиториев представлены в формате `google-auth-library-[name of language]`.

Если вы используете **Facebook**, выполните на сайте [Facebook для разработчиков](https://developers.facebook.com) поиск по запросу "library" или "sdk". 

Если вы ищете **общие библиотеки OAuth 2.0**, откройте страницу [Код OAuth](http://oauth.net/code/), которую обновляет рабочая группа IETF по OAuth. Эта страница содержит ссылки на библиотеки, рассчитанные на более десятка языков. Обратите внимание, что некоторые из этих библиотек предназначены для реализации службы, поддерживающей OAuth. На этой странице библиотеки, представляющие интерес для разработчиков надстроек, называются *клиентскими* библиотеками, так как веб-сервер является клиентом службы, поддерживающей OAuth.

## Службы-посредники

Вы также можете использовать службу-посредник, например Auth0, которая предоставляет маркеры доступа для многих популярных веб-служб, а также позволяет более простым способом обеспечить вход через социальные сети для надстройки. Достаточно добавить совсем немного кода, чтобы надстройка могла использовать сценарий на стороне клиента или серверный код для подключения к посреднику и возвращала все необходимые маркеры для веб-службы. Весь код, реализующий авторизацию, находится в службе-посреднике. 

У нас есть пример, использующий Auth0 для входа с помощью учетных записей Facebook, Google и Майкрософт:

[Office-Add-in-Auth0](https://github.com/OfficeDev/Office-Add-in-Auth0)

## Что такое CORS?

CORS расшифровывается как [общий доступ к ресурсам независимо от источника](https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS) (Cross Origin Resource Sharing). Сведения об использовании CORS в надстройках см. в статье [Устранение в надстройках Office ограничений, вызванных принципом одинакового источника](http://dev.office.com/docs/add-ins/develop/addressing-same-origin-policy-limitations).
